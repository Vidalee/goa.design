---
title: "gRPCサービスの設計"
linkTitle: "設計"
weight: 1
description: "サービス定義、メソッドのアノテーション、protobufの生成、適切なgRPCステータスコードのマッピングを含む、GoaでのgRPCサービスの設計方法を学びます。"
---

このチュートリアルでは、Goaを使用して簡単なgRPCサービスを**設計**します。Goaは
RESTエンドポイントによく使用されますが、**gRPC**トランスポートにも
ファーストクラスのサポートを提供します。以下の方法を学びます：

- GoaのDSLでサービスとメソッドを定義する
- `.proto`ファイルを生成するコードを生成するようにgRPCのアノテーションを付ける
- ペイロードを検証し、エラーをgRPCステータスコードにマッピングする

## 作成するもの

`SayHello`という単一のメソッドを持つ**`greeter`**サービスを作成します。
このメソッドはペイロードで名前を受け取り、挨拶メッセージを返します。また、
標準的なgRPCコードでgRPCレスポンスを**修飾**する方法も示します。

| メソッド | gRPC RPC | 説明 |
|----------|---------------|---------------------------------------------|
| SayHello | rpc SayHello | ユーザーが提供した名前に対する挨拶を返す |

## 1. 新しいモジュールとフォルダの作成

このプロジェクト`grpcgreeter`のための新しいGoモジュールを作成します：

```bash
mkdir grpcgreeter
cd grpcgreeter
go mod init grpcgreeter
```

このフォルダ内に、DSLファイルを格納する`design/`ディレクトリを設定します：

```bash
mkdir design
```

## 2. サービス設計の記述

以下の内容で`design/greeter.go`というファイルを作成します：

```go
package design

import (
    . "goa.design/goa/v3/dsl"
)

// gRPCベースのgreeterサービスを定義
var _ = Service("greeter", func() {
    Description("シンプルなgRPCサービスで挨拶を返します。")

    Method("SayHello", func() {
        Description("ユーザーに挨拶を送信します。")

        // リクエストペイロード（クライアントが送信するもの）を定義
        Payload(func() {
            Field(1, "name", String, "挨拶する相手の名前", func() {
                Example("Alice")
                MinLength(1)
            })
            Required("name")
        })

        // 結果（サーバーが返すもの）を定義
        Result(func() {
            Field(1, "greeting", String, "フレンドリーな挨拶メッセージ")
            Required("greeting")
        })

        // このメソッドをgRPC経由で公開することを示す
        GRPC(func() {
            // 成功レスポンスのデフォルトコードはCodeOK（0）です。
            // 必要に応じてカスタムマッピングも定義できます：
            // Response(CodeOK)
        })
    })
})
```

### 重要なポイント

- `Method("SayHello", ...)`を使用してリモートプロシージャコールを定義します。
- **Payload**は入力フィールドを指定します。gRPCの用語では、これはリクエスト
  メッセージになります。
- **Result**は出力フィールドを定義します。gRPCの用語では、これはレスポンス
  メッセージになります。
- **`GRPC(func() {...})`**を追加することで、生成されるコードに`.proto`
  定義とこのメソッドのスタブが含まれることを保証します。
- `Field(1, "name", String, ...)`を使用してリクエストとレスポンス
  メッセージのフィールドを定義します。数字は生成される`.proto`ファイルの
  タグです。これはHTTPメソッドでフィールドを定義する際の`Attribute`の使用に
  代わるものです。HTTPとgRPCの両方のトランスポートをサポートするメソッドは、
  フィールドの定義に`Field`を使用できます（タグはHTTPでは無視されます）。

## 3. 次のステップ

**gRPCサービス設計**が完了したら、次のチュートリアルに進みましょう：

- [サービスの実装](./2-implementing.md)：
  コードを生成し、カスタムロジックを組み込み、GoaでgRPCサーバーを実行する方法を学びます。
- [サービスの実行](./3-running.md)：
  公式のgRPC CLIやその他のツールを使用してエンドポイントを呼び出し、すべてが正しく動作することを確認する方法を探ります。

これでGoaを使用して最小限のgRPCサービスを**設計**しました。DSLアプローチにより、
リクエスト/レスポンスの型、バリデーション、gRPCステータスマッピングの
**単一の信頼できる情報源**が提供され、サービスを時間とともに**進化させ**、
**維持する**ことが容易になります！ 