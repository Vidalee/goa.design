---
title: gRPCインターセプター
weight: 4
description: >
  実践的な例と統合パターンを通じて、Goaサービスと効果的に連携するgRPCインターセプターの作成方法を学びます。
---

Goaサービスは標準的なgRPCインターセプターを使用するため、標準パターンに従う任意のgRPC
インターセプターを使用できます。このガイドでは、実際の使用例から、Goaサービスとうまく
連携する効果的なgRPCインターセプターの作成方法を説明します。

gRPCインターセプターは、メタデータの処理、接続管理、メッセージ変換などのプロトコルレベルの
関心事に焦点を当てるべきです。ビジネスロジックやサービスのペイロードとリザルトへの型安全な
アクセスには、代わりにGoaインターセプターを使用してください。Goaインターセプターはサービスの
ドメイン型に直接アクセスでき、ビジネスレベルの関心事により適しています。

## インターセプターの種類

gRPCは、異なるユースケースに対応する2種類のインターセプターをサポートしています：

1. **ユナリーインターセプター**：従来のAPIコールのような単一のリクエスト/レスポンスRPCを
   処理します。これらは実装がより簡単で、最も一般的な種類です。

2. **ストリームインターセプター**：クライアント、サーバー、または両方が複数のメッセージを
   送信できるストリーミングRPCを処理します。これらはストリームのライフサイクルのより複雑な
   処理が必要です。

## 一般的なユースケース

以下は、gRPCインターセプターが特に有用な一般的なシナリオです：

1. **メタデータの伝播**：トレースID、リクエストID、その他のメタデータの処理
3. **ロギング**：RPCメソッドの呼び出しとその結果の記録
4. **モニタリング**：RPCコールに関するメトリクスの収集
5. **エラー処理**：gRPCとドメインエラー間の変換
6. **レート制限**：受信リクエストのレートの制御
7. **負荷制御**：高負荷時のサービスの保護

## ベストプラクティス

GoaサービスのgRPCインターセプターを実装する際は：

1. **プロトコルの関心事に焦点を当てる**：メタデータ処理などのプロトコルレベルの操作には
   gRPCインターセプターを使用します。ビジネスロジックにはGoaインターセプターを使用します。

2. **コンテキストを適切に処理する**：常にコンテキストのキャンセルを尊重し、コンテキスト値を
   正しく伝播させます。

3. **一貫性を保つ**：予測可能な動作のために、サービス全体で同じインターセプターパターンを
   適用します。

4. **パフォーマンスを考慮する**：インターセプターはすべてのリクエストで実行されるため、
   効率的に保ちます。

5. **エラー処理**：適切なgRPCステータスコードを使用し、関連するエラー詳細を含めます。

6. **テスト**：エラーケースとコンテキストのキャンセルを含め、インターセプターを徹底的に
   テストします。

## Goaとの統合

以下は、gRPCインターセプターをGoaサービスと統合する方法です：

```go
func main() {
    // インターセプター付きのgRPCサーバーを作成
    srv := grpc.NewServer(
        grpc.UnaryInterceptor(grpc_middleware.ChainUnaryServer(
            // プロトコルレベルの関心事をgRPCインターセプターで処理
            MetadataInterceptor(),
            LoggingInterceptor(),
            MonitoringInterceptor(),
        )),
        grpc.StreamInterceptor(grpc_middleware.ChainStreamServer(
            StreamMetadataInterceptor(),
            StreamLoggingInterceptor(),
            StreamMonitoringInterceptor(),
        )),
    )

    // Goa gRPCサーバーを登録
    pb.RegisterServiceServer(srv, server)
}
```

この例は以下を示しています：
- `go-grpc-middleware`パッケージを使用した複数のインターセプターのチェーン
- ユナリーインターセプターとストリームインターセプターの分離
- プロトコルレベルの関心事への焦点

## 次のステップ

- [ユナリーインターセプター](@/docs/4-concepts/5-interceptors/3-grpc-interceptors/1-unary.md)について学ぶ
- [ストリームインターセプター](@/docs/4-concepts/5-interceptors/3-grpc-interceptors/2-stream.md)を探索する
- ビジネスロジックのための[Goaインターセプター](@/docs/4-concepts/5-interceptors/1-overview.md)を確認する
- エラー変換戦略のための[エラー処理](@/docs/4-concepts/4-error-handling.md)をチェックする 